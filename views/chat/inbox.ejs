<%- include('../partials/header') %>

    <div class="container fade-in">
        <div class="section-header" style="margin-top: 2rem;">
            <h2>Inbox</h2>
        </div>

        <div class="message-list">
            <% if (conversations && conversations.length> 0) { %>
                <% conversations.forEach(convo=> { %>
                    <a href="/chat/start/<%= convo.userId %>?productId=<%= convo.productId %>"
                        class="message-card <%= convo.unreadCount > 0 ? 'unread' : '' %>">
                        <div class="card-left">
                            <div class="user-avatar-wrapper">
                                <% if (convo.isAnonymous) { %>
                                    <img src="/images/default-avatar.png" class="user-avatar" alt="Anonymous">
                                    <% } else { %>
                                        <img src="/uploads/<%= convo.avatar || 'default-avatar.png' %>"
                                            class="user-avatar" alt="User">
                                        <% } %>
                                            <% if (convo.unreadCount> 0) { %>
                                                <span class="unread-dot"></span>
                                                <% } %>
                            </div>
                            <div class="card-details">
                                <div class="card-header-row">
                                    <h4>
                                        <%= convo.name %>
                                            <% if (convo.studentId) { %>
                                                <small style="font-size: 0.8em; color: #666;">(<%= convo.studentId %>
                                                        )</small>
                                                <% } %>
                                    </h4>
                                    <span class="timestamp">
                                        <%= convo.timestamp ? new Date(convo.timestamp).toLocaleString([], {
                                            month: 'short' , day: 'numeric' , hour: '2-digit' , minute: '2-digit' })
                                            : '' %>
                                    </span>
                                </div>
                                <div class="product-context">
                                    <% if (convo.productImage) { %>
                                        <img src="<%= convo.productImage %>" class="mini-product-thumb" alt="Product">
                                        <span>
                                            <%= convo.productTitle %>
                                        </span>
                                        <% } else { %>
                                            <span><i class="fas fa-box"></i>
                                                <%= convo.productTitle || 'General Chat' %>
                                            </span>
                                            <% } %>
                                </div>
                                <p class="last-message">
                                    <% if (convo.lastSenderId && convo.lastSenderId.toString()===user._id.toString()) {
                                        %>
                                        <strong>You:</strong>
                                        <%= convo.lastMessage %>
                                            <% } else { %>
                                                <%= convo.lastMessage %>
                                                    <% } %>
                                </p>
                            </div>
                        </div>
                        <% if (convo.unreadCount> 0) { %>
                            <div class="card-right">
                                <span class="badge">
                                    <%= convo.unreadCount %>
                                </span>
                            </div>
                            <% } %>
                                <div class="card-actions-hover">
                                    <form action="/chat/delete/<%= convo.userId %>?productId=<%= convo.productId %>"
                                        method="POST" onsubmit="return confirm('Delete this conversation history?')">
                                        <button type="submit" class="btn-icon-sm delete-chat"
                                            onclick="event.stopPropagation(); event.preventDefault(); if(confirm('Delete this conversation?')) this.form.submit(); return false;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                    </a>
                    <% }) %>
                        <% } else { %>
                            <div class="empty-state">
                                <i class="fas fa-inbox fa-3x"></i>
                                <p>No messages yet. Start a chat from a product listing!</p>
                            </div>
                            <% } %>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const userId = '<%= user._id %>';

        socket.emit('join', userId);

        socket.on('message', (msg) => {
            // Reload page to reflect new state (simple and robust for now)
            // Or implement dynamic DOM update (more complex with sorting)
            // Given the requirement "if i dont refresh... not shown", auto-reload is a quick fix.
            // But a seamless update is better. Let's try seamless.

            // Actually, for sorting and unread counts, refreshing is much safer to keep state consistent 
            // without duplicating all the controller logic in JS.
            // But refreshing interrupts user interaction.
            // Let's do a simple reload for now as it guarantees "most recent message on top".
            window.location.reload();
        });
    </script>

    <%- include('../partials/footer') %>