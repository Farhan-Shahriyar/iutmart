<%- include('../partials/header') %>

    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <div class="bg-surface border border-border rounded-lg shadow-2xl overflow-hidden h-[80vh] flex flex-col">
            <!-- Comms Header -->
            <div class="bg-bg border-b border-border p-4 flex justify-between items-center bg-grid">
                <div>
                    <h2 class="text-xl font-bold text-white font-mono flex items-center gap-2">
                        <i class="fas fa-satellite-dish text-action animate-pulse"></i>
                        SECURE COMMS
                    </h2>
                    <p class="text-[10px] text-text-secondary font-mono tracking-wider">ENCRYPTED P2P MESSAGING RELAY
                    </p>
                </div>
                <div class="text-xs text-text-secondary font-mono flex items-center space-x-3">
                    <span class="flex items-center"><span
                            class="w-1.5 h-1.5 rounded-full bg-bull mr-1 animate-pulse"></span> ONLINE</span>
                    <span class="opacity-50">|</span>
                    <span>v2.4.0-enc</span>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto p-4 space-y-2 bg-bg/50">
                <% if (conversations && conversations.length> 0) { %>
                    <% conversations.forEach(convo=> { %>
                        <a href="/chat/start/<%= convo.userId %>?productId=<%= convo.productId %>"
                            class="block bg-surface border border-border hover:border-action hover:bg-white/5 transition p-3 rounded group relative overflow-hidden">

                            <% if (convo.unreadCount> 0) { %>
                                <div class="absolute left-0 top-0 bottom-0 w-1 bg-action animate-pulse"></div>
                                <% } %>

                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-4">
                                            <div class="relative">
                                                <div
                                                    class="w-12 h-12 bg-black rounded border border-border overflow-hidden ring-1 ring-border group-hover:ring-action transition">
                                                    <% if (convo.isAnonymous) { %>
                                                        <div
                                                            class="w-full h-full flex items-center justify-center bg-surface text-text-secondary">
                                                            <i class="fas fa-user-secret text-xl"></i>
                                                        </div>
                                                        <% } else { %>
                                                            <img src="<%= convo.avatar || 'https://ui-avatars.com/api/?name=' + convo.name + '&background=0b0e11&color=fff' %>"
                                                                class="w-full h-full object-cover"
                                                                onerror="this.src='https://ui-avatars.com/api/?name=<%= convo.name %>&background=0b0e11&color=fff'">
                                                            <% } %>
                                                </div>
                                                <% if (convo.unreadCount> 0) { %>
                                                    <div
                                                        class="absolute -top-1 -right-1 w-4 h-4 bg-action rounded-none flex items-center justify-center text-[10px] text-white font-bold border border-bg shadow-lg shadow-action/50">
                                                        <%= convo.unreadCount %>
                                                    </div>
                                                    <% } %>
                                            </div>

                                            <div>
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span
                                                        class="text-sm font-bold text-white font-mono group-hover:text-action transition">
                                                        <% if (convo.isAnonymous) { %>
                                                            <span class="text-bear">ENCRYPTED CHANNEL</span>
                                                            <% } else { %>
                                                                <%= convo.name.replace(/\d+/g, '' ).trim() %>
                                                                    <% } %>
                                                    </span>
                                                    <% if (convo.studentId && !convo.isAnonymous) { %>
                                                        <span
                                                            class="text-[10px] text-text-secondary border border-border px-1 rounded font-mono">
                                                            ID: <%= convo.studentId.toString().slice(-4) %>
                                                        </span>
                                                        <% } %>
                                                            <span
                                                                class="text-[10px] text-text-secondary font-mono ml-2 opacity-50">
                                                                <%= convo.timestamp ? new
                                                                    Date(convo.timestamp).toLocaleDateString([],
                                                                    {month:'short', day:'numeric'}) : '' %>
                                                            </span>
                                                </div>

                                                <div class="flex items-center gap-2 text-xs text-text-secondary">
                                                    <% if (convo.productImage) { %>
                                                        <img src="<%= convo.productImage %>"
                                                            class="w-4 h-4 rounded-sm object-cover border border-border">
                                                        <% } else { %>
                                                            <i class="fas fa-box text-[10px]"></i>
                                                            <% } %>
                                                                <span
                                                                    class="font-mono text-[10px] uppercase tracking-wide text-text-secondary/70">REF:
                                                                    <%= convo.productTitle || 'GENERAL' %>
                                                                </span>
                                                </div>

                                                <p
                                                    class="text-sm text-text-secondary mt-1 line-clamp-1 font-mono group-hover:text-white transition group-hover:translate-x-1 duration-200">
                                                    <% if (convo.lastSenderId &&
                                                        convo.lastSenderId.toString()===user._id.toString()) { %>
                                                        <span class="text-action select-none">You: </span>
                                                        <% } %>
                                                            <span class="opacity-80">
                                                                <%= convo.lastMessage %>
                                                            </span>
                                                </p>
                                            </div>
                                        </div>

                                        <div class="flex flex-col items-end gap-2">
                                            <form
                                                action="/chat/delete/<%= convo.userId %>?productId=<%= convo.productId %>"
                                                method="POST"
                                                onsubmit="return confirm('ERASE COMM LOG? This cannot be undone.')">
                                                <button type="submit"
                                                    class="text-text-secondary hover:text-bear transition text-xs opacity-0 group-hover:opacity-100 p-2"
                                                    onclick="event.stopPropagation();">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                            <div
                                                class="px-2 py-1 bg-bg border border-border rounded text-[10px] font-mono text-text-secondary group-hover:border-action/50 transition">
                                                OPEN UPLINK
                                            </div>
                                        </div>
                                    </div>
                        </a>
                        <% }) %>
                            <% } else { %>
                                <div
                                    class="flex flex-col items-center justify-center h-full text-center text-text-secondary opacity-50">
                                    <div
                                        class="w-16 h-16 rounded-full border border-dashed border-text-secondary flex items-center justify-center mb-4">
                                        <i class="fas fa-comment-slash text-2xl"></i>
                                    </div>
                                    <p class="font-mono text-sm tracking-widest">NO ACTIVE TRANSMISSIONS</p>
                                    <p class="text-xs font-mono mt-2">awaiting_incoming_packets...</p>
                                </div>
                                <% } %>
            </div>

            <div
                class="p-3 bg-bg border-t border-border flex justify-between items-center text-[10px] text-text-secondary font-mono">
                <span>SECURE_SOCKET_LAYER: ACTIVE</span>
                <span>LATENCY: 12ms</span>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const userId = '<%= user._id %>';
        socket.emit('join', userId);
        socket.on('message', (msg) => {
            window.location.reload();
        });
    </script>

    <%- include('../partials/footer') %>