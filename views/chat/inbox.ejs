<%- include('../partials/header') %>

    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <div class="bg-surface border border-border rounded-lg shadow-2xl overflow-hidden h-[80vh] flex flex-col">
            <!-- Comms Header -->
            <div class="bg-bg border-b border-border p-4 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-white font-mono flex items-center gap-2">
                        <i class="fas fa-satellite-dish text-action animate-pulse"></i>
                        SECURE COMMS
                    </h2>
                    <p class="text-[10px] text-text-secondary font-mono tracking-wider">ENCRYPTED P2P MESSAGING RELAY
                    </p>
                </div>
                <div class="text-xs text-text-secondary font-mono">
                    NET STATUS: <span class="text-bull">ONLINE</span>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto p-4 space-y-2">
                <% if (conversations && conversations.length> 0) { %>
                    <% conversations.forEach(convo=> { %>
                        <a href="/chat/start/<%= convo.userId %>?productId=<%= convo.productId %>"
                            class="block bg-bg border border-border hover:border-action transition p-3 rounded group relative overflow-hidden">

                            <% if (convo.unreadCount> 0) { %>
                                <div class="absolute left-0 top-0 bottom-0 w-1 bg-action animate-pulse"></div>
                                <% } %>

                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-4">
                                            <div class="relative">
                                                <div
                                                    class="w-12 h-12 bg-black rounded border border-border overflow-hidden">
                                                    <% if (convo.isAnonymous) { %>
                                                        <div
                                                            class="w-full h-full flex items-center justify-center bg-surface text-text-secondary">
                                                            <i class="fas fa-user-secret text-xl"></i>
                                                        </div>
                                                        <% } else { %>
                                                            <img src="/uploads/<%= convo.avatar || 'default-avatar.png' %>"
                                                                class="w-full h-full object-cover"
                                                                onerror="this.src='https://ui-avatars.com/api/?name=<%= convo.name %>&background=0b0e11&color=fff'">
                                                            <% } %>
                                                </div>
                                                <% if (convo.unreadCount> 0) { %>
                                                    <div
                                                        class="absolute -top-1 -right-1 w-4 h-4 bg-action rounded-full flex items-center justify-center text-[10px] text-white font-bold border border-bg">
                                                        <%= convo.unreadCount %>
                                                    </div>
                                                    <% } %>
                                            </div>

                                            <div>
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span
                                                        class="text-sm font-bold text-white font-mono group-hover:text-action transition">
                                                        <%= convo.name %>
                                                    </span>
                                                    <% if (convo.studentId) { %>
                                                        <span
                                                            class="text-[10px] text-text-secondary border border-border px-1 rounded font-mono">
                                                            <%= convo.studentId %>
                                                        </span>
                                                        <% } %>
                                                            <span
                                                                class="text-[10px] text-text-secondary font-mono ml-2">
                                                                <%= convo.timestamp ? new
                                                                    Date(convo.timestamp).toLocaleDateString([],
                                                                    {month:'short', day:'numeric'}) : '' %>
                                                            </span>
                                                </div>

                                                <div class="flex items-center gap-2 text-xs text-text-secondary">
                                                    <% if (convo.productImage) { %>
                                                        <img src="<%= convo.productImage %>"
                                                            class="w-4 h-4 rounded object-cover border border-border">
                                                        <% } else { %>
                                                            <i class="fas fa-box text-[10px]"></i>
                                                            <% } %>
                                                                <span
                                                                    class="font-mono text-[10px] uppercase tracking-wide text-text-secondary/70">REF:
                                                                    <%= convo.productTitle || 'GENERAL' %></span>
                                                </div>

                                                <p
                                                    class="text-sm text-text-secondary mt-1 line-clamp-1 font-mono group-hover:text-white transition group-hover:translate-x-1 duration-200">
                                                    <% if (convo.lastSenderId &&
                                                        convo.lastSenderId.toString()===user._id.toString()) { %>
                                                        <span class="text-action select-none">>> </span>
                                                        <% } %>
                                                            <%= convo.lastMessage %>
                                                </p>
                                            </div>
                                        </div>

                                        <div class="flex flex-col items-end gap-2">
                                            <form
                                                action="/chat/delete/<%= convo.userId %>?productId=<%= convo.productId %>"
                                                method="POST"
                                                onsubmit="return confirm('ERASE COMM LOG? This cannot be undone.')">
                                                <button type="submit"
                                                    class="text-text-secondary hover:text-bear transition text-xs opacity-0 group-hover:opacity-100 p-2"
                                                    onclick="event.stopPropagation();">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                            <i
                                                class="fas fa-chevron-right text-border group-hover:text-action transition"></i>
                                        </div>
                                    </div>
                        </a>
                        <% }) %>
                            <% } else { %>
                                <div
                                    class="flex flex-col items-center justify-center h-full text-center text-text-secondary opacity-50">
                                    <i class="fas fa-comment-slash text-4xl mb-4"></i>
                                    <p class="font-mono text-sm">NO ACTIVE TRANSMISSIONS</p>
                                    <p class="text-xs">INITIATE TRAFFIC FROM ASSET TERMINALS</p>
                                </div>
                                <% } %>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const userId = '<%= user._id %>';
        socket.emit('join', userId);
        socket.on('message', (msg) => {
            window.location.reload();
        });
    </script>

    <%- include('../partials/footer') %>